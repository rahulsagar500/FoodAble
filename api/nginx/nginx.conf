worker_processes  1;
events { worker_connections 1024; }

http {
  include       mime.types;
  sendfile      on;
  keepalive_timeout 65;

  # Use Docker's embedded DNS for service-name resolution
  resolver 127.0.0.11 ipv6=off valid=30s;

  server {
    listen 4000;

    # Common proxy headers
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # ---- Runtime DNS: use variables so nginx resolves at request time ----
    set $auth_up     http://auth:4001;
    set $catalog_up  http://catalog:4002;
    set $orders_up   http://orders:4003;

    # Health
    location = /healthz { return 200 "ok\n"; }

    # -------- Auth service --------
    location /api/auth/ {
      proxy_pass $auth_up;
    }

    # -------- Orders service --------
    location = /api/cart/checkout {
      proxy_pass $orders_up;
    }

    # Regex: /api/offers/:id/reserve  (IMPORTANT: no URI part on proxy_pass)
    location ~* ^/api/offers/[^/]+/reserve$ {
      proxy_pass $orders_up;
    }

    # -------- Catalog service --------
    location /api/restaurants {
      proxy_pass $catalog_up;
    }
    location /api/offers {
      proxy_pass $catalog_up;
    }
    location /api/me/ {
      proxy_pass $catalog_up;
    }
  }
}
